<!DOCTYPE html>
    <html><head>
    <meta charset='utf-8'>

    <script src='sl.mapapi2.js'></script>
    <link rel='stylesheet' type='text/css' href='sl.mapapi2.css'>



    <style>
    div#both {
        marging: 0px;
        padding: 0px;
        background-color: black;
    }
    div#map-container {
        width: 1500px;//492px;   
        height: 1000px;//1016px; 
        //border:4px solid black;
        padding: 8px 8px 8px 16px;
        display: inline-block;
        //background-color: black;
        float: left;
        position: absolute;
         
    }
    div#left-side {
        width: 520px; //492px;
        //height: 500px; 
        //border:4px solid black;
        //padding: 8px 16px 8px 8px;
        display: inline-block;
        float: right;
        background-color: green;
        position: relative;
    }
    div#columns {
        border:4px solid black;
        display: inline-block;
    }
    div#2-columns {
        border:4px solid black;
        display: inline-block;
    }
    div#1-columns {
        border:4px solid black;
        display: inline-block;
        float: left;
    }
    div#map-container2 {
        width: 500px; //492px;
        height: 500px; 
        //border:4px solid black;
        padding: 8px 8px 8px 8px;
        display: inline-block;
        float: right;
        //background-color: black;
        position: relative;
    }
    div#search-box {
        width: 220px; //492px;
        //height: 500px; 
        border:4px solid black;
        padding: 8px 16px 8px 8px;
        display: inline-grid;
        float: right;
        //background-color: black;
        position: relative;
    }
    div#wp_boxes {
        display:list-item;
    }
    div#waypoint-list-box {
        width: 220px; //492px;
        //height: 500px; 
        border:4px solid black;
        padding: 8px 16px 8px 8px;
        display: inline-grid;
        float: right;
        //background-color: black;
        position: relative;
    }
    div#points-list-box {
        width: 220px; //492px;
        //height: 500px; 
        border:4px solid black;
        padding: 8px 16px 8px 8px;
        display: inline-grid;
        float: left;
        //background-color: black;
        position: relative;
    }
    body {
        margin: 0px;
        border:0px;
        background-color: white;// black;
    }
    </style>

    </head><body> 
    
    <div id='map-container'></div>
    <div id='left-side'>

        <div id='map-container2'></div>
        
        <div id='columns'>
            <div id='1-columns'>
                <div id='points-list-box'>
                    <label>Route:</label>
                    <select id='rLSelect' name='rLSelect' multiple size='22'>
                    </select>
                    <button type="button"  onclick="alert('Hello World!')">Go!</button> 
                </div>
            </div>
            
            <div id='2-columns'>
                
                <div id='search-box'>
                    <label for='search-label'>Search waypoint by coords:</br></label>
                    <div id='wp_boxes'>
                        
                        <input type='text' id='x' name='x' required style='width:90px' display='inline-flex' />
                        <input type='text' id='y' name='y' required style='width:90px' display='inline-flex' />
                        <form action='' method='GET'>
                        <input type="hidden" id="c" name="c" value="">
                        <input type="hidden" id="rL" name="rL" value="">
                        <input type="hidden" id="wL" name="wL" value="">
                        <input type='submit' value='Go!' display='inline-flex' onclick="populateAllHidden()">
                        </form>
                    </div>
                </div>
                

                <div id='waypoint-list-box'>
                    <label>Waypoints:</label>
                    <select id='wpLSelect' name='wpLSelect' multiple size='17'>
                    </select>
                    <button type="button"  >Populate hidden rL.</button> 
                    <button type="button" onclick="alert('Hello World!')">Go!</button> 
                </div>
            </div>
        </div>
    </div>
            
    </body></html>

    <script>

	// load 2 maps and set some functions
	var routeMap = new SLMap(document.getElementById('map-container'));
	var latlngStart = L.latLng(1000,1000);
	routeMap.setView(latlngStart, 7);
	
	var waypointsMap = new SLMap(document.getElementById('map-container2'));
	waypointsMap.setView(latlngStart, 3); 
	
	routeMap.doubleClickZoom.disable();
	waypointsMap.doubleClickZoom.disable();
	
	// create lists for route and waypoints
	let routeListX = [];
	let routeListY = [];
	let waypointsListX = [];
	let waypointsListY = [];

	// create map layers for the coordinates
	let routeMapLayer = [];
	let routeWPMapLayer = [];
	let waypointsMapLayer = [];
	let waypointsRouteMapLayer = [];
	
	// white box used as an idicator for simple click and when focusing a coordinate
	let coordFocus = null;
	let wpFocus = null;

	// retrieve data from URL parameters
	const urlParams = new URLSearchParams(window.location.search);
	const coordFromUrl = urlParams.get('c');
	const routeListFromUrl = urlParams.get('rL');
	const waypointListFromUrl = urlParams.get('wL');
	
	// fill hidden inputs with data coming from the get url
	const rLHiddenInput = document.getElementById("rL")
	rLHiddenInput.value = routeListFromUrl;
	const wpLHiddenInput = document.getElementById("wL")
	wpLHiddenInput.value = waypointListFromUrl;
	const cHiddenInput = document.getElementById("c")
	cHiddenInput.value = "";

	// get HTML elements on the page
	const x = document.getElementById('x');
	const y = document.getElementById('y');
	const rLSelect = document.getElementById('rLSelect');
	const wpLSelect = document.getElementById('wpLSelect');

	// set the value of passed coord to the input field
	if(coordFromUrl) {
		const coordinate = coordFromUrl.split('z');
		x.value = coordinate.at(0); 
		y.value = coordinate.at(1); 
	}

	// make the route list from the get url and show it on the map
	if(routeListFromUrl) {
		const route = routeListFromUrl.split('X');
		for (let i = 0; i < route.length; i++) {
			const coordsArr = route.at(i).split("z");
			let x = coordsArr.at(0);
			let y = coordsArr.at(1);

			addToRouteSelect(x, y, i);

			routeListX.push(x);
			routeListY.push(y);
		}
		populateRoute();
	}

	// make the waypoint list from the get url and show it on the map
	if(waypointListFromUrl) {
		const waypoints = waypointListFromUrl.split('X');
		for (let i = 0; i < waypoints.length; i++) {
			const wpArr = waypoints.at(i).split("z");
			let x = wpArr.at(0);
			let y = wpArr.at(1);

			addToWaypointsSelect(x, y, i);

			waypointsListX.push(x);
			waypointsListY.push(y);
		}
		populateWaypoints();
	}

//	var region_route = L.polygon([[x,y], [x, y+1], [x+1, y+1], [x+1, y]], 
//			{ color: 'red', fillColor: 'red', fillOpacity: 0.5, stroke: false,
//			}).addTo(waypointsMap);
	
	const popup = L.popup()
		.setLatLng([latlngStart.lat+0.5,latlngStart.lng+0.5])
		.setContent('Starting point.')
		.openOn(waypointsMap);



	/// functions for route map


		
	// simple left click on map
	function onRouteMapClick(e) {

		let x = parseInt(e.latlng.lat);
		let y = parseInt(e.latlng.lng);

		//console.log(L.getTileUrl(latlng));

		//https://map.secondlife.com/map-1-1000-996-objects.jpg

		setFocusOnCoord(x, y);
		
		var tooltip = L.tooltip()
			.setLatLng([x+0.5,y+0.0])
			.setContent(x+","+y)
			.openOn(routeMap)
			.setOpacity(0.9);
	}

	// double left click on map
	function onRouteMapDbClick(e) {

		let x = parseInt(e.latlng.lat);
		let y = parseInt(e.latlng.lng);
		
		addRouteCoord(x,y);

		setFocusOnCoord(x,y);
	}

	// sets fuctions for simple and double click on the map
	routeMap.on('dblclick', onRouteMapDbClick);
	routeMap.on('click', onRouteMapClick);
	
	// add a coordinate to all lists and map
	function addRouteCoord(x, y) {
		var alreadyExist = isRouteCoord(x,y);
		//console.log(alreadyExist);
		// coord does not exist yet, add
		if(alreadyExist == -1) {
			
			var routeCoord = L.polygon([[x,y], [x, y+1], [x+1, y+1], [x+1, y]], 
			{ color: 'lightgreen', fillColor: 'lightgreen', fillOpacity: 0.5, stroke: false,
			}).addTo(routeMap);
			routeMapLayer.push(routeCoord);
			
			var routeWP = L.polygon([[x,y], [x, y+1], [x+1, y+1], [x+1, y]], 
			{ color: 'lightgreen', fillColor: 'lightgreen', fillOpacity: 0.5, stroke: false,
			}).addTo(waypointsMap);
			routeWPMapLayer.push(routeWP);
			
			routeListX.push(x);
			routeListY.push(y);
			//console.log(x +","+y);
			addToRouteSelect(x, y, routeListX.length);
		} 
		else { // coord already exist, remove
			routeMapLayer.at(alreadyExist).remove();
			routeWPMapLayer.at(alreadyExist).remove();
			
			routeMapLayer.splice(alreadyExist,1);
			routeWPMapLayer.splice(alreadyExist,1);
			
			routeListX.splice(alreadyExist,1);
			routeListY.splice(alreadyExist,1);

			removeFromRouteSelect(alreadyExist);
		}

		//console.log(routeListX);
		//console.log(routeListY);
	}

	// center map at this coord
	function goToCoord(x, y) {
		setFocusOnCoord(parseInt(x),parseInt(y));

		var coord = L.latLng(parseInt(x),parseInt(y));
		routeMap.setView(coord);
	}

	// verify if coord is on the route list
	function isRouteCoord(x, y) {
		for (let i = 0; i < routeListX.length; i++) {
			  if(routeListX.at(i) == x) {
				  if(routeListY.at(i) == y) {
					  //console.log(i);
					  return i;
				  }
			  }
		}
		return -1;
	}

	// draw coords on both maps and fill the route list
	function populateRoute() {
		for (let i = 0; i < routeListX.length; i++) {
			let x = parseInt(routeListX.at(i));
			let y = parseInt(routeListY.at(i));
			//console.log(x +","+y);
			
			var routeCoord = L.polygon([[x,y], [x, y+1], [x+1, y+1], [x+1, y]], 
			{ color: 'lightgreen', fillColor: 'lightgreen', fillOpacity: 0.5, stroke: false,
			}).addTo(routeMap);
			
			var routeWPCoord = L.polygon([[x,y], [x, y+1], [x+1, y+1], [x+1, y]], 
			{ color: 'lightgreen', fillColor: 'lightgreen', fillOpacity: 0.5, stroke: false,
			}).addTo(waypointsMap);
			
			routeMapLayer.push(routeCoord);
			routeWPMapLayer.push(routeWPCoord);
			//console.log(x +","+y);
		}
	}

	// fill select with the route coords list
	function addToRouteSelect(x, y, i) {
		const option = document.createElement('option');
		option.textContent = x + "," + y;
		option.value = i; 

		option.addEventListener("click", function() {
			  goToCoord(x,y);
			}); 
		rLSelect.appendChild(option);
	}
	
	// remove coord from route select
	function removeFromRouteSelect(i) {
		rLSelect.remove(i);
	}

	// fill the hidden input and then get url with the route list
	function populateHiddenRL() {
		let fillHiddenRL = '';
		for (let i = 0; i < routeListX.length; i++) {
			if(i > 0) fillHiddenRL += "X";
			fillHiddenRL += routeListX.at(i) + "z";
			fillHiddenRL += routeListY.at(i);
		}
		rLHiddenInput.value = fillHiddenRL;
		//alert(fillHiddenRL);
	}

	// draw a white square on the coord
	function setFocusOnCoord(x, y) {
		//console.log(x+","+y);

		if(coordFocus != null) {
			coordFocus.remove();
			coordFocus = null;
		}

		coordFocus = L.polyline([[x, y], [x, y+1], [x+1, y+1], [x+1, y], [x, y]], 
						{ color: 'white', weight: 7,				
						}).addTo(routeMap);
	}


    /// functions for wp map


	// sets fuctions for simple and double click on the map
	waypointsMap.on('dblclick', onWaypointsMapDbClick);
	waypointsMap.on('click', onWaypointsMapClick);

	// simple left click on wp map
	function onWaypointsMapClick(e) {

		let x = parseInt(e.latlng.lat);
		let y = parseInt(e.latlng.lng);

		//console.log(L.getTileUrl(latlng));

		//https://map.secondlife.com/map-1-1000-996-objects.jpg

		setFocusOnWaypointsMap(x, y);
	}

	// double left click on wp map
	function onWaypointsMapDbClick(e) {

		let x = parseInt(e.latlng.lat);
		let y = parseInt(e.latlng.lng);
		
		addWaypoint(x,y);

		setFocusOnWaypointsMap(x,y);
	}

	// add a coordinate to wp list and both maps
	function addWaypoint(x, y) {
		var alreadyExist = isWaypoint(x,y);
		//console.log(alreadyExist);
		// wp does not exist yet, add
		if(alreadyExist == -1) {
			
			var routeCoord = L.polygon([[x,y], [x, y+1], [x+1, y+1], [x+1, y]], 
			{ color: 'red', fillColor: 'red', fillOpacity: 0.5, stroke: false,
			}).addTo(routeMap);
			waypointsRouteMapLayer.push(routeCoord);
			
			var routeWP = L.polygon([[x,y], [x, y+1], [x+1, y+1], [x+1, y]], 
			{ color: 'red', fillColor: 'red', fillOpacity: 0.5, stroke: false,
			}).addTo(waypointsMap);
			waypointsMapLayer.push(routeWP);
			
			waypointsListX.push(x);
			waypointsListY.push(y);
			//console.log(x +","+y);
			addToWaypointsSelect(x, y, waypointsListX.length);
		} 
		else { // wp already exist, remove
			waypointsRouteMapLayer.at(alreadyExist).remove();
			waypointsMapLayer.at(alreadyExist).remove();
			
			waypointsRouteMapLayer.splice(alreadyExist,1);
			waypointsMapLayer.splice(alreadyExist,1);
			
			waypointsListX.splice(alreadyExist,1);
			waypointsListY.splice(alreadyExist,1);

			removeFromWaypointsSelect(alreadyExist);
		}

		//console.log(routeListX);
		//console.log(routeListY);
	}

	// center map at this waypoint
	function goToWaypoint(x, y) {
		setFocusOnWaypointsMap(parseInt(x),parseInt(y));

		var coord = L.latLng(parseInt(x),parseInt(y));
		waypointsMap.setView(coord);
	}

	// check if it is a waypoint on the list
	function isWaypoint(x, y) {
		for (let i = 0; i < waypointsListX.length; i++) {
			  if(waypointsListX.at(i) == x) {
				  if(waypointsListY.at(i) == y) {
					  //console.log(i);
					  return i;
				  }
			  }
		}
		return -1;
	}

	// draw coords on the both maps and fill the wp list
	function populateWaypoints() {
		for (let i = 0; i < waypointsListX.length; i++) {
			let x = parseInt(waypointsListX.at(i));
			let y = parseInt(waypointsListY.at(i));
			//console.log(x +","+y);
			
			var routeCoord = L.polygon([[x,y], [x, y+1], [x+1, y+1], [x+1, y]], 
			{ color: 'red', fillColor: 'red', fillOpacity: 0.5, stroke: false,
			}).addTo(routeMap);
			
			var routeWPCoord = L.polygon([[x,y], [x, y+1], [x+1, y+1], [x+1, y]], 
			{ color: 'red', fillColor: 'red', fillOpacity: 0.5, stroke: false,
			}).addTo(waypointsMap);
			
			waypointsRouteMapLayer.push(routeCoord);
			waypointsMapLayer.push(routeWPCoord);
			//console.log(x +","+y);
		}
	}

	// fill select with the route coords list
	function addToWaypointsSelect(x, y, i) {
		const option = document.createElement('option');
		option.textContent = x + "," + y;
		option.value = i; 

		option.addEventListener("click", function() {
			  goToWaypoint(x,y);
			}); 
		wpLSelect.appendChild(option);
	}

	// remove coord from route select
	function removeFromWaypointsSelect(i) {
		wpLSelect.remove(i);
	}

	// fill the hidden input and then get url with the route list
	function populateHiddenWPL() {
		let fillHiddenWPL = '';
		for (let i = 0; i < waypointsListX.length; i++) {
			if(i > 0) fillHiddenWPL += "X";
			fillHiddenWPL += waypointsListX.at(i) + "z";
			fillHiddenWPL += waypointsListY.at(i);
		}
		wpLHiddenInput.value = fillHiddenWPL;
		//alert(fillHiddenRL);
	}

	// draw a white square on the coord
	function setFocusOnWaypointsMap(x, y) {
		if(wpFocus != null) {
			wpFocus.remove();
			wpFocus = null;
		}

		wpFocus = L.polyline([[x, y], [x, y+1], [x+1, y+1], [x+1, y], [x, y]], 
						{ color: 'red', weight: 3,				
						}).addTo(waypointsMap);
	}
	
	function populateAllHidden() {
		populateHiddenRL()
		populateHiddenWPL();
	}

    </script>